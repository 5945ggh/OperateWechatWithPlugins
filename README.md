# OWCP - An Advanced, Asynchronous WeChat Robot Framework
![Python Version](https://img.shields.io/badge/python-3.8+-blue.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)

**OWCP (Object-oriented Wechat Controller with Plugins)** æ˜¯ä¸€ä¸ªåŸºäº `wxauto` æ„å»ºçš„å¼€å‘å‹å¥½çš„ã€ç°ä»£åŒ–çš„å¾®ä¿¡æœºå™¨äººæ¡†æ¶ã€‚å®ƒä¸“ä¸ºæ„å»ºç¨³å®šã€å¯æ‰©å±•ã€æ˜“äºç»´æŠ¤çš„å¤æ‚æœºå™¨äººåº”ç”¨è€Œè®¾è®¡ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

* **å¼‚æ­¥ä¼˜å…ˆ (Async First)**: åŸºäº `asyncio` æ„å»ºï¼Œä¸»å¾ªç¯æ°¸è¿œä¸ä¼šè¢«é˜»å¡ï¼Œç¡®ä¿äº†é«˜å“åº”æ€§å’Œé«˜æ€§èƒ½ã€‚
* **é«˜åº¦å¯æ‰©å±• (Extensible)**: å®Œå–„çš„æ’ä»¶ç³»ç»Ÿï¼Œå…è®¸ä½ é€šè¿‡ç¼–å†™ç‹¬ç«‹çš„ `Command`, `Filter`, `Responser` ç­‰æ’ä»¶ï¼Œè½»æ¾æ³¨å…¥è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ã€‚
* **å½»åº•è§£è€¦ (Decoupled)**: æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œå°†çŠ¶æ€ç®¡ç† (`Manager`)ã€å¾®ä¿¡I/O (`Driver`)ã€ä¸šåŠ¡é€»è¾‘ (`Loop`) å’Œå®‰å…¨æ¥å£ (`Controller`) å½»åº•åˆ†ç¦»ã€‚
* **å¹¶å‘å®‰å…¨ (Concurrency Safe)**: ç‹¬åˆ›çš„ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶ (`WxTaskQueue`)ï¼Œå°†æ‰€æœ‰UIå†™æ“ä½œï¼ˆå¦‚å‘æ¶ˆæ¯ã€æ·»åŠ ç›‘å¬ï¼‰ä¸²è¡ŒåŒ–ï¼Œä»æ ¹æœ¬ä¸Šæœç»äº†UIè‡ªåŠ¨åŒ–ä¸­çš„é¼ æ ‡å†²çªé—®é¢˜ã€‚
* **é¢å‘å¯¹è±¡ (Object-Oriented)**: ä¸‡ç‰©çš†å¯¹è±¡ã€‚æ¯ä¸€ä¸ªç›‘å¬ä¼šè¯éƒ½æ˜¯ä¸€ä¸ªçŠ¶æ€ç‹¬ç«‹ã€è¡Œä¸ºæ¸…æ™°çš„ `ListenObject`ã€‚

## ğŸ›ï¸ æ ¸å¿ƒæ¶æ„ç†å¿µ

æœ¬æ¡†æ¶çš„æ ¸å¿ƒæ˜¯â€œèŒè´£åˆ†ç¦»åŸåˆ™â€ã€‚æˆ‘ä»¬å°†ä¸€ä¸ªå¤æ‚çš„æœºå™¨äººæ‹†åˆ†ä¸ºå››ä¸ªååŒå·¥ä½œçš„æ ¸å¿ƒç»„ä»¶ï¼š

```mermaid
graph TD
    A[ç”¨æˆ·/æ’ä»¶] -->|é€šè¿‡å®‰å…¨æ¥å£| B(LoopController);
    B -->|å§”æ‰˜æŒ‡ä»¤| C{"ListenLoop (åè°ƒå™¨)"};
    B -->|å§”æ‰˜æŒ‡ä»¤| D["ListenObjectManager (çŠ¶æ€)"];
    B -->|å§”æ‰˜æŒ‡ä»¤| E["WxDriver (I/O)"];

    C -->|è·å–å¯¹è±¡| D;
    C -->|è·å–/å‘é€æ¶ˆæ¯| E;

    E -->|æ”¾å…¥ä»»åŠ¡| F[WxTaskQueue];
    G[wxauto_worker] -->|æ‰§è¡Œä»»åŠ¡| F;
    G -->|æ“ä½œ| H[å¾®ä¿¡å®¢æˆ·ç«¯UI];
    H -->|è¿”å›æ¶ˆæ¯| E;

    subgraph æ¡†æ¶æ ¸å¿ƒ
        C; D; E; F; G;
    end

    subgraph å¤–éƒ¨ä¸–ç•Œ
        A; H;
    end
```

1.  **ListenObjectManager (çŠ¶æ€ä¸­å¿ƒ)**: çº¯ç²¹çš„ã€åç¨‹å®‰å…¨çš„çŠ¶æ€ç®¡ç†å™¨ï¼Œè´Ÿè´£åœ¨å†…å­˜ä¸­ç»´æŠ¤æ‰€æœ‰ `ListenObject` çš„é›†åˆã€‚
2.  **WxDriver (I/Oé©±åŠ¨)**: å°è£…äº†æ‰€æœ‰ä¸ `wxauto` çš„åº•å±‚äº¤äº’ã€‚å®ƒä¸ç›´æ¥æ‰§è¡ŒUIæ“ä½œï¼Œè€Œæ˜¯å°†å®ƒä»¬æ‰“åŒ…æˆä»»åŠ¡æ”¾å…¥å…¨å±€é˜Ÿåˆ—ã€‚
3.  **WxTaskQueue & Worker (å®‰å…¨æ‰§è¡Œå™¨)**: å…¨å±€å”¯ä¸€çš„ä»»åŠ¡é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ã€‚å®ƒç¡®ä¿æ‰€æœ‰æ¨¡æ‹Ÿé¼ æ ‡çš„æ“ä½œéƒ½æŒ‰é¡ºåºã€ä¸€æ¬¡ä¸€ä¸ªåœ°æ‰§è¡Œï¼Œä¿è¯äº†ç»å¯¹çš„UIå®‰å…¨ã€‚
4.  **ListenLoop (ä¸šåŠ¡åè°ƒå™¨)**: æ¡†æ¶çš„â€œå¤§è„‘â€ï¼Œé©±åŠ¨äº‹ä»¶å¾ªç¯ï¼Œä»`Driver`è·å–æ¶ˆæ¯ï¼Œä»`Manager`è·å–å¯¹è±¡çŠ¶æ€ï¼Œå¹¶æŒ‰é¡ºåºæ‰§è¡Œæ’ä»¶é€»è¾‘ã€‚
5.  **LoopController (å®‰å…¨é—¨é¢)**: ä¸ºæ’ä»¶æä¾›çš„ä¸€ä¸ªåŠŸèƒ½å—é™çš„ã€ç¨³å®šçš„APIæ¥å£ï¼Œç”¨äºæ§åˆ¶æœºå™¨äººï¼Œè€Œæ— éœ€æš´éœ²æ¡†æ¶å†…éƒ¨ç»†èŠ‚ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…

```bash
pip install wxauto pyyaml
# ç¡®ä¿ä½ çš„ç¯å¢ƒä¸­å·²å®‰è£… wxauto å’Œ pyyaml
```
å°†æˆ‘ä»¬æœ€ç»ˆç‰ˆæœ¬çš„ `OWCP4.py` å’Œ `WxTaskQueue.py` æ”¾åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ã€‚

### 2. é¡¹ç›®ç»“æ„

å»ºè®®é‡‡ç”¨ä»¥ä¸‹ç›®å½•ç»“æ„ï¼š
```
your_project/
â”œâ”€â”€ OWCP(version).py
â”œâ”€â”€ WxTaskQueue.py
â”œâ”€â”€ CommonCommands.py
â”œâ”€â”€ CommonFilters.py
â”œâ”€â”€ CommonResponsers.py
â””â”€â”€ main.py
```

### 3. ç¼–å†™ä¸»å¯åŠ¨æ–‡ä»¶ `main.py`

è¿™æ˜¯å°†æ‰€æœ‰ç»„ä»¶ç²˜åˆåœ¨ä¸€èµ·çš„å¯åŠ¨è„šæœ¬ã€‚

```python
# main.py

# ä»æˆ‘ä»¬çš„æ¡†æ¶æ–‡ä»¶ä¸­å¯¼å…¥æ‰€æœ‰éœ€è¦çš„ç±»
from OWCP(version) import (
    ListenObject, Admin, Group, Friend,ListenObjectManager,
    PluginManager, 
    ListenLoop
)

# ä»æ’ä»¶æ–‡æ¡£ä¸­å¯¼å…¥æ’ä»¶
from CommonFilters import FilterSYS
from CommonResponsers import PrintMsg

initial_objects = [
    Group("ç›¸äº²ç›¸çˆ±ä¸€å®¶äºº", group_managers={"è€å©†": 100}),
    Admin("è€å©†", level=100)
]

# åˆå§‹åŒ–æ’ä»¶ç®¡ç†å™¨å¹¶æ³¨å†Œæ’ä»¶
plugin_manager = PluginManager().register_all([
    FilterSYS(), #è¿‡æ»¤ç³»ç»Ÿæ¶ˆæ¯
    PrintMsg() #åœ¨cmdæ‰“å°æ”¶åˆ°çš„æ¶ˆæ¯
])

# åˆå§‹åŒ–ç›‘å¬å¾ªç¯
loop = ListenLoop(
    plugin_manager=plugin_manager, #ä¼ å…¥æ’ä»¶ç®¡ç†å™¨ 
    processing_mode=ProcessingMode.CONCURRENT #è®¾ç½®æ¶ˆæ¯å¤„ç†ä¸ºå¹¶å‘æ¨¡å¼ï¼Œä¿è¯æœ€å¤§ååé‡
    )

if __name__ == '__main__':
    # å¯åŠ¨ç›‘å¬å¾ªç¯
    loop.launch(initial_objects)
```

### 4. è¿è¡Œ

ç°åœ¨ï¼Œç™»å½•ä½ çš„PCå¾®ä¿¡ï¼Œç„¶åè¿è¡Œä¸»è„šæœ¬ï¼š
```bash
python main.py
```
ä½ å°†çœ‹åˆ°æœºå™¨äººå¯åŠ¨ã€è¿æ¥ã€åŒæ­¥ï¼Œå¹¶å¼€å§‹ç›‘å¬æ¶ˆæ¯ï¼

### 5. ç¼–å†™æ’ä»¶

ç¼–å†™æ’ä»¶éå¸¸ç®€å•ï¼Œåªéœ€è¦ç»§æ‰¿ `MsgFilter`,`MsgResponser`ç­‰æŠ½è±¡åŸºç±»,å¹¶æŒ‰ç…§docstringçš„æç¤ºå®ç° `execute` æ–¹æ³•å³å¯ã€‚
ä¾‹å¦‚:

```python
# å‘½ä»¤æ’ä»¶
class PauseAndStop(Command):
    def __init__(self):
        super().__init__(
            description="æš‚åœ/åœæ­¢ç›‘å¬å¾ªç¯",
            scope=CommandScope.ADMIN_DIRECT # åªèƒ½ç”±Adminåœ¨ç§èŠä¸­è§¦å‘
        )
    async def execute(self, controller: 'LoopController', driver: 'WxDriver', context: 'CommandContext'):
        if context.admin_level < 1:
            return  # æƒé™ä¸è¶³
        if context.msg.content == startswith("/"): #è‡ªä¸»å®šä¹‰å‘½ä»¤è§¦å‘æ¡ä»¶
            if context.msg.content == ("/pause"):
                await controller.pause()
                await driver.quote(context.msg, "*ç›‘å¬å¾ªç¯å·²æš‚åœ*")
            elif context.msg.content == ("/stop"):
                await controller.stop()
                await driver.quote(context.msg, "*ç›‘å¬å¾ªç¯å·²å…³é—­*")
```

## éƒ¨ç½²æ³¨æ„äº‹é¡¹

* **Windows Server**: UIè‡ªåŠ¨åŒ–ä¾èµ–äºå‰å°çª—å£ã€‚ä¸ºäº†é˜²æ­¢æœåŠ¡å™¨åœ¨æ— äººå€¼å®ˆæ—¶è‡ªåŠ¨é”å±ï¼Œè¯·è°ƒæ•´ç³»ç»Ÿç”µæº/é”å±ç­–ç•¥ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Pull Request æˆ– Issue æ¥å¸®åŠ©æˆ‘æ”¹è¿›æ¡†æ¶.

## License

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE)ã€‚



---
## OWCP æ¡†æ¶æ ¸å¿ƒAPIæ–‡æ¡£
ä»¥ä¸‹æ˜¯OWCPæ¡†æ¶ä¸»è¦ç±»çš„å±æ€§ä¸æ–¹æ³•çš„è¯¦ç»†åˆ—è¡¨ï¼Œæ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›æ¸…æ™°çš„å‚è€ƒã€‚
### ä¸€ã€ æ ¸å¿ƒå¼•æ“ç»„ä»¶
è¿™äº›ç±»æ„æˆäº†æ¡†æ¶çš„â€œå¼•æ“å®¤â€ï¼Œè´Ÿè´£é©±åŠ¨æ•´ä¸ªåº”ç”¨ã€‚
#### `ListenLoop`
**èŒè´£**: æ¡†æ¶çš„â€œå¤§è„‘â€ä¸æ€»æŒ‡æŒ¥ï¼Œè´Ÿè´£åè°ƒæ‰€æœ‰ç»„ä»¶ï¼Œé©±åŠ¨äº‹ä»¶å¾ªç¯ï¼Œå¹¶æä¾›æœ€ç»ˆçš„ç”¨æˆ·å¯åŠ¨å…¥å£ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `__init__(...)` | æ–¹æ³• | æ„é€ å‡½æ•°ã€‚é€šè¿‡ **ä¾èµ–æ³¨å…¥** æ¥æ”¶æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ (`manager`, `driver`, `plugin_manager`)ï¼Œå¹¶æ¥å—å¯é€‰çš„è¿è¡Œæ¨¡å¼å‚æ•°ã€‚|
| `launch(initial_objects)` | æ–¹æ³• | **ã€å¼€å‘è€…è°ƒç”¨çš„å”¯ä¸€ä¸»å…¥å£ã€‘**ã€‚è¿™æ˜¯ä¸€ä¸ª **åŒæ­¥** æ–¹æ³•ï¼Œå°è£…äº†æ‰€æœ‰å¯åŠ¨é€»è¾‘ï¼ˆè¿æ¥ã€åŒæ­¥ã€è¿è¡Œã€å¼‚å¸¸å¤„ç†ã€å…³é—­ï¼‰ï¼Œè®©ç”¨æˆ·æ— éœ€å…³å¿ƒ`asyncio`ç»†èŠ‚ï¼Œä¸€è¡Œä»£ç å³å¯å¯åŠ¨æœºå™¨äººã€‚ |
| `run()` (`_run_main_loop`) | `async` æ–¹æ³• | **ï¼ˆå†…éƒ¨æ ¸å¿ƒï¼‰** çœŸæ­£çš„ä¸»äº‹ä»¶å¾ªç¯ã€‚å®ƒå‘¨è€Œå¤å§‹åœ°ä»`driver`è·å–æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¾å®šçš„å¤„ç†æ¨¡å¼ï¼ˆä¸²è¡Œ/å¹¶å‘ï¼‰æ¥è°ƒåº¦æ¶ˆæ¯å¤„ç†ã€‚ |
#### `WxDriver`
**èŒè´£**: å°è£…æ‰€æœ‰ä¸`wxauto`çš„åº•å±‚I/Oäº¤äº’ã€‚å®ƒæ˜¯æ¡†æ¶ä¸å¾®ä¿¡å®¢æˆ·ç«¯æ²Ÿé€šçš„å”¯ä¸€æ¡¥æ¢ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `__init__(...)` | æ–¹æ³• | æ„é€ å‡½æ•°ã€‚æ¥æ”¶ `language` å’Œ `sending_delay` ç­‰é…ç½®ã€‚ |
| `wx` | å±æ€§ | `WeChat`å®ä¾‹ã€‚åœ¨`connect()`æˆåŠŸåè¢«èµ‹å€¼ï¼Œä»£è¡¨å·²è¿æ¥çš„å¾®ä¿¡å®¢æˆ·ç«¯ã€‚ |
| `sending_delay` | å±æ€§ | æ¯ä¸ªUIå†™æ“ä½œä¹‹é—´çš„æœ€å°å»¶è¿Ÿï¼Œç¡®ä¿ç¨³å®šæ€§ã€‚ |
| `connect()` | `async` æ–¹æ³• | **ï¼ˆé˜»å¡æ“ä½œï¼‰** è¿æ¥åˆ°PCå¾®ä¿¡å®¢æˆ·ç«¯ã€‚å¿…é¡»åœ¨æ‰€æœ‰ä»»åŠ¡å¼€å§‹å‰å®Œæˆã€‚ |
| `get_listen_messages()` | `async` æ–¹æ³• | **ï¼ˆåªè¯»æ“ä½œï¼‰** ä»å¾®ä¿¡è·å–æ‰€æœ‰è¢«ç›‘å¬å¯¹è±¡çš„æ–°æ¶ˆæ¯ã€‚è¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥æ‰§è¡Œçš„UIè¯»æ“ä½œã€‚ |
| `sync_object_to_wx(obj)` | `async` æ–¹æ³• | **ï¼ˆå…¥é˜Ÿä»»åŠ¡ï¼‰** å°†ä¸€ä¸ª`ListenObject`çš„çŠ¶æ€ï¼ˆå¦‚æ˜¯å¦å­˜å›¾ï¼‰åŒæ­¥åˆ°`wxauto`çš„ç›‘å¬åˆ—è¡¨ã€‚ |
| `remove_object_from_wx(name)` | `async` æ–¹æ³• | **ï¼ˆå…¥é˜Ÿä»»åŠ¡ï¼‰** ä»`wxauto`çš„ç›‘å¬åˆ—è¡¨ä¸­ç§»é™¤ä¸€ä¸ªå¯¹è±¡ã€‚ |
| `send_text(...)` | `async` æ–¹æ³• | **ï¼ˆå…¥é˜Ÿä»»åŠ¡ï¼‰** è¯·æ±‚å‘é€ä¸€æ¡æ–‡æœ¬æ¶ˆæ¯ã€‚ |
| `send_file(...)` | `async` æ–¹æ³• | **ï¼ˆå…¥é˜Ÿä»»åŠ¡ï¼‰** è¯·æ±‚å‘é€ä¸€ä¸ªæ–‡ä»¶ã€‚ |
#### `ListenObjectManager`
**èŒè´£**: çº¯ç²¹çš„ã€åç¨‹å®‰å…¨çš„çŠ¶æ€ä¸­å¿ƒã€‚è´Ÿè´£åœ¨å†…å­˜ä¸­ç»Ÿä¸€ç®¡ç†æ‰€æœ‰`ListenObject`çš„çŠ¶æ€ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `__init__()` | æ–¹æ³• | åˆå§‹åŒ–ä¸€ä¸ªå†…éƒ¨å­—å…¸å’Œç”¨äºä¿è¯åç¨‹å®‰å…¨çš„`asyncio.Lock`ã€‚ |
| `setup_initial_objects(objects)` | `async` æ–¹æ³• | ä½¿ç”¨åˆå§‹å¯¹è±¡åˆ—è¡¨å¡«å……ç®¡ç†å™¨ï¼Œæ­¤æ“ä½œä¼šæ¸…ç©ºæ—§æ•°æ®ã€‚ |
| `add(obj)` | `async` æ–¹æ³• | å®‰å…¨åœ°æ·»åŠ æˆ–è¦†ç›–ä¸€ä¸ª`ListenObject`ã€‚ |
| `remove(name)` | `async` æ–¹æ³• | æ ¹æ®åç§°å®‰å…¨åœ°ç§»é™¤ä¸€ä¸ª`ListenObject`ã€‚ |
| `get(name)` | `async` æ–¹æ³• | æ ¹æ®åç§°å®‰å…¨åœ°è·å–ä¸€ä¸ª`ListenObject`å®ä¾‹ã€‚ |
| `get_all_dict()` | `async` æ–¹æ³• | å®‰å…¨åœ°è·å–å½“å‰æ‰€æœ‰`ListenObject`çš„å­—å…¸æ‹·è´ã€‚ |
#### `LoopController`
**èŒè´£**: æä¾›ç»™æ’ä»¶çš„ã€åŠŸèƒ½å—é™çš„â€œå®‰å…¨é—¨é¢â€ã€‚æ’ä»¶é€šè¿‡å®ƒæ¥ä¸æ¡†æ¶æ ¸å¿ƒäº¤äº’ï¼Œå®ç°åŠ¨æ€æ§åˆ¶ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `pause_loop()` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæš‚åœæ•´ä¸ªæœºå™¨äººçš„ä¸»å¾ªç¯ã€‚ |
| `resume_loop()` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæ¢å¤æ•´ä¸ªæœºå™¨äººçš„ä¸»å¾ªç¯ã€‚ |
| `end_loop()` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šå®‰å…¨åœ°ç»“æŸæ•´ä¸ªæœºå™¨äººç¨‹åºã€‚ |
| `pause_listen_object(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæš‚åœå¯¹æŒ‡å®šåç§°å¯¹è±¡çš„ç›‘å¬ã€‚ |
| `resume_listen_object(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæ¢å¤å¯¹æŒ‡å®šåç§°å¯¹è±¡çš„ç›‘å¬ã€‚ |
| `add_listen_object(obj)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šå®‰å…¨åœ°æ–°å¢æˆ–æ›´æ–°ä¸€ä¸ªç›‘å¬å¯¹è±¡ï¼ˆçŠ¶æ€å’Œå¾®ä¿¡I/OåŒæ­¥è¿›è¡Œï¼‰ã€‚ |
| `remove_listen_object(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šå®‰å…¨åœ°ç§»é™¤ä¸€ä¸ªç›‘å¬å¯¹è±¡ã€‚ |
| `pause_plugin_by_name(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæš‚åœæŒ‡å®šåç§°çš„æ’ä»¶ã€‚ |
| `resume_plugin_by_name(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæ¢å¤æŒ‡å®šåç§°çš„æ’ä»¶ã€‚ |
### äºŒã€ æ•°æ®æ¨¡å‹
è¿™äº›ç±»å®šä¹‰äº†æ¡†æ¶æ“ä½œçš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚
#### `ListenObject` (æŠ½è±¡åŸºç±»)
**èŒè´£**: æ‰€æœ‰è¢«ç›‘å¬å¯¹è±¡ï¼ˆç®¡ç†å‘˜ã€ç¾¤ã€å¥½å‹ï¼‰çš„é€šç”¨æŠ½è±¡ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `name` | å±æ€§ | å¯¹è±¡çš„å”¯ä¸€åç§°ï¼ˆé€šå¸¸æ˜¯å¾®ä¿¡å¤‡æ³¨åï¼‰ã€‚ |
| `type` | å±æ€§ (åªè¯») | å¯¹è±¡çš„ç±»å‹ (`ListenObjectType`æšä¸¾)ã€‚ |
| `messages` | å±æ€§ | `MessageHistory`å®ä¾‹ï¼Œå­˜å‚¨--
## OWCP æ¡†æ¶æ ¸å¿ƒAPIæ–‡æ¡£
ä»¥ä¸‹æ˜¯OWCPæ¡†æ¶ä¸»è¦ç±»çš„å±æ€§ä¸æ–¹æ³•çš„è¯¦ç»†åˆ—è¡¨ï¼Œæ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›æ¸…æ™°çš„å‚è€ƒã€‚
### ä¸€ã€ æ ¸å¿ƒå¼•æ“ç»„ä»¶
è¿™äº›ç±»æ„æˆäº†æ¡†æ¶çš„â€œå¼•æ“å®¤â€ï¼Œè´Ÿè´£é©±åŠ¨æ•´ä¸ªåº”ç”¨ã€‚
#### `ListenLoop`
**èŒè´£**: æ¡†æ¶çš„â€œå¤§è„‘â€ä¸æ€»æŒ‡æŒ¥ï¼Œè´Ÿè´£åè°ƒæ‰€æœ‰ç»„ä»¶ï¼Œé©±åŠ¨äº‹ä»¶å¾ªç¯ï¼Œå¹¶æä¾›æœ€ç»ˆçš„ç”¨æˆ·å¯åŠ¨å…¥å£ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `__init__(...)` | æ–¹æ³• | æ„é€ å‡½æ•°ã€‚é€šè¿‡ **ä¾èµ–æ³¨å…¥** æ¥æ”¶æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ (`manager`, `driver`, `plugin_manager`)ï¼Œå¹¶æ¥å—å¯é€‰çš„è¿è¡Œæ¨¡å¼å‚æ•°ã€‚|
| `launch(initial_objects)` | æ–¹æ³• | **ã€å¼€å‘è€…è°ƒç”¨çš„å”¯ä¸€ä¸»å…¥å£ã€‘**ã€‚è¿™æ˜¯ä¸€ä¸ª **åŒæ­¥** æ–¹æ³•ï¼Œå°è£…äº†æ‰€æœ‰å¯åŠ¨é€»è¾‘ï¼ˆè¿æ¥ã€åŒæ­¥ã€è¿è¡Œã€å¼‚å¸¸å¤„ç†ã€å…³é—­ï¼‰ï¼Œè®©ç”¨æˆ·æ— éœ€å…³å¿ƒ`asyncio`ç»†èŠ‚ï¼Œä¸€è¡Œä»£ç å³å¯å¯åŠ¨æœºå™¨äººã€‚ |
| `run()` (`_run_main_loop`) | `async` æ–¹æ³• | **ï¼ˆå†…éƒ¨æ ¸å¿ƒï¼‰** çœŸæ­£çš„ä¸»äº‹ä»¶å¾ªç¯ã€‚å®ƒå‘¨è€Œå¤å§‹åœ°ä»`driver`è·å–æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¾å®šçš„å¤„ç†æ¨¡å¼ï¼ˆä¸²è¡Œ/å¹¶å‘ï¼‰æ¥è°ƒåº¦æ¶ˆæ¯å¤„ç†ã€‚ |
#### `WxDriver`
**èŒè´£**: å°è£…æ‰€æœ‰ä¸`wxauto`çš„åº•å±‚I/Oäº¤äº’ã€‚å®ƒæ˜¯æ¡†æ¶ä¸å¾®ä¿¡å®¢æˆ·ç«¯æ²Ÿé€šçš„å”¯ä¸€æ¡¥æ¢ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `__init__(...)` | æ–¹æ³• | æ„é€ å‡½æ•°ã€‚æ¥æ”¶ `language` å’Œ `sending_delay` ç­‰é…ç½®ã€‚ |
| `wx` | å±æ€§ | `WeChat`å®ä¾‹ã€‚åœ¨`connect()`æˆåŠŸåè¢«èµ‹å€¼ï¼Œä»£è¡¨å·²è¿æ¥çš„å¾®ä¿¡å®¢æˆ·ç«¯ã€‚ |
| `sending_delay` | å±æ€§ | æ¯ä¸ªUIå†™æ“ä½œä¹‹é—´çš„æœ€å°å»¶è¿Ÿï¼Œç¡®ä¿ç¨³å®šæ€§ã€‚ |
| `connect()` | `async` æ–¹æ³• | **ï¼ˆé˜»å¡æ“ä½œï¼‰** è¿æ¥åˆ°PCå¾®ä¿¡å®¢æˆ·ç«¯ã€‚å¿…é¡»åœ¨æ‰€æœ‰ä»»åŠ¡å¼€å§‹å‰å®Œæˆã€‚ |
| `get_listen_messages()` | `async` æ–¹æ³• | **ï¼ˆåªè¯»æ“ä½œï¼‰** ä»å¾®ä¿¡è·å–æ‰€æœ‰è¢«ç›‘å¬å¯¹è±¡çš„æ–°æ¶ˆæ¯ã€‚è¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥æ‰§è¡Œçš„UIè¯»æ“ä½œã€‚ |
| `sync_object_to_wx(obj)` | `async` æ–¹æ³• | **ï¼ˆå…¥é˜Ÿä»»åŠ¡ï¼‰** å°†ä¸€ä¸ª`ListenObject`çš„çŠ¶æ€ï¼ˆå¦‚æ˜¯å¦å­˜å›¾ï¼‰åŒæ­¥åˆ°`wxauto`çš„ç›‘å¬åˆ—è¡¨ã€‚ |
| `remove_object_from_wx(name)` | `async` æ–¹æ³• | **ï¼ˆå…¥é˜Ÿä»»åŠ¡ï¼‰** ä»`wxauto`çš„ç›‘å¬åˆ—è¡¨ä¸­ç§»é™¤ä¸€ä¸ªå¯¹è±¡ã€‚ |
| `send_text(...)` | `async` æ–¹æ³• | **ï¼ˆå…¥é˜Ÿä»»åŠ¡ï¼‰** è¯·æ±‚å‘é€ä¸€æ¡æ–‡æœ¬æ¶ˆæ¯ã€‚ |
| `send_file(...)` | `async` æ–¹æ³• | **ï¼ˆå…¥é˜Ÿä»»åŠ¡ï¼‰** è¯·æ±‚å‘é€ä¸€ä¸ªæ–‡ä»¶ã€‚ |
#### `ListenObjectManager`
**èŒè´£**: çº¯ç²¹çš„ã€åç¨‹å®‰å…¨çš„çŠ¶æ€ä¸­å¿ƒã€‚è´Ÿè´£åœ¨å†…å­˜ä¸­ç»Ÿä¸€ç®¡ç†æ‰€æœ‰`ListenObject`çš„çŠ¶æ€ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `__init__()` | æ–¹æ³• | åˆå§‹åŒ–ä¸€ä¸ªå†…éƒ¨å­—å…¸å’Œç”¨äºä¿è¯åç¨‹å®‰å…¨çš„`asyncio.Lock`ã€‚ |
| `setup_initial_objects(objects)` | `async` æ–¹æ³• | ä½¿ç”¨åˆå§‹å¯¹è±¡åˆ—è¡¨å¡«å……ç®¡ç†å™¨ï¼Œæ­¤æ“ä½œä¼šæ¸…ç©ºæ—§æ•°æ®ã€‚ |
| `add(obj)` | `async` æ–¹æ³• | å®‰å…¨åœ°æ·»åŠ æˆ–è¦†ç›–ä¸€ä¸ª`ListenObject`ã€‚ |
| `remove(name)` | `async` æ–¹æ³• | æ ¹æ®åç§°å®‰å…¨åœ°ç§»é™¤ä¸€ä¸ª`ListenObject`ã€‚ |
| `get(name)` | `async` æ–¹æ³• | æ ¹æ®åç§°å®‰å…¨åœ°è·å–ä¸€ä¸ª`ListenObject`å®ä¾‹ã€‚ |
| `get_all_dict()` | `async` æ–¹æ³• | å®‰å…¨åœ°è·å–å½“å‰æ‰€æœ‰`ListenObject`çš„å­—å…¸æ‹·è´ã€‚ |
#### `LoopController`
**èŒè´£**: æä¾›ç»™æ’ä»¶çš„ã€åŠŸèƒ½å—é™çš„â€œå®‰å…¨é—¨é¢â€ã€‚æ’ä»¶é€šè¿‡å®ƒæ¥ä¸æ¡†æ¶æ ¸å¿ƒäº¤äº’ï¼Œå®ç°åŠ¨æ€æ§åˆ¶ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `pause_loop()` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæš‚åœæ•´ä¸ªæœºå™¨äººçš„ä¸»å¾ªç¯ã€‚ |
| `resume_loop()` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæ¢å¤æ•´ä¸ªæœºå™¨äººçš„ä¸»å¾ªç¯ã€‚ |
| `end_loop()` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šå®‰å…¨åœ°ç»“æŸæ•´ä¸ªæœºå™¨äººç¨‹åºã€‚ |
| `pause_listen_object(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæš‚åœå¯¹æŒ‡å®šåç§°å¯¹è±¡çš„ç›‘å¬ã€‚ |
| `resume_listen_object(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæ¢å¤å¯¹æŒ‡å®šåç§°å¯¹è±¡çš„ç›‘å¬ã€‚ |
| `add_listen_object(obj)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šå®‰å…¨åœ°æ–°å¢æˆ–æ›´æ–°ä¸€ä¸ªç›‘å¬å¯¹è±¡ï¼ˆçŠ¶æ€å’Œå¾®ä¿¡I/OåŒæ­¥è¿›è¡Œï¼‰ã€‚ |
| `remove_listen_object(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šå®‰å…¨åœ°ç§»é™¤ä¸€ä¸ªç›‘å¬å¯¹è±¡ã€‚ |
| `pause_plugin_by_name(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæš‚åœæŒ‡å®šåç§°çš„æ’ä»¶ã€‚ |
| `resume_plugin_by_name(name)` | `async` æ–¹æ³• | æŒ‡ä»¤æ¥å£ï¼šæ¢å¤æŒ‡å®šåç§°çš„æ’ä»¶ã€‚ |
### äºŒã€ æ•°æ®æ¨¡å‹
è¿™äº›ç±»å®šä¹‰äº†æ¡†æ¶æ“ä½œçš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚
#### `ListenObject` (æŠ½è±¡åŸºç±»)
**èŒè´£**: æ‰€æœ‰è¢«ç›‘å¬å¯¹è±¡ï¼ˆç®¡ç†å‘˜ã€ç¾¤ã€å¥½å‹ï¼‰çš„é€šç”¨æŠ½è±¡ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `name` | å±æ€§ | å¯¹è±¡çš„å”¯ä¸€åç§°ï¼ˆé€šå¸¸æ˜¯å¾®ä¿¡å¤‡æ³¨åï¼‰ã€‚ |
| `type` | å±æ€§ (åªè¯») | å¯¹è±¡çš„ç±»å‹ (`ListenObjectType`æšä¸¾)ã€‚ |
| `messages` | å±æ€§ | `MessageHistory`å®ä¾‹ï¼Œå­˜å‚¨è¯¥å¯¹è±¡çš„æ¶ˆæ¯å†å²ã€‚ |
| `savepic`\<br\>`savevoice`\<br\>`savefile` | å±æ€§ (åªè¯») | å¸ƒå°”å€¼ï¼Œæ ‡è¯†æ˜¯å¦ä¿å­˜ç‰¹å®šç±»å‹çš„åª’ä½“æ–‡ä»¶ã€‚ |
| `max_msgs` | å±æ€§ (è¯»/å†™) | è¯¥å¯¹è±¡èƒ½å­˜å‚¨çš„æœ€å¤§å†å²æ¶ˆæ¯æ•°ã€‚ |
| `add_msg(msg)` | æ–¹æ³• | å‘æ¶ˆæ¯å†å²ä¸­æ·»åŠ ä¸€æ¡æ¶ˆæ¯ã€‚ |
| `clear_msg(num)` | æ–¹æ³• | æ¸…é™¤æŒ‡å®šæ•°é‡çš„æ—§æ¶ˆæ¯ã€‚ |
| `get_messages()` | æ–¹æ³• | è·å–æ‰€æœ‰å†å²æ¶ˆæ¯çš„åˆ—è¡¨æ‹·è´ã€‚ |
| `pause()` / `resume()` | æ–¹æ³• | æš‚åœ/æ¢å¤å¯¹è¯¥å¯¹è±¡çš„å¤„ç†ï¼ˆåœ¨ä¸»å¾ªç¯ä¸­ç”Ÿæ•ˆï¼‰ã€‚ |
| \`is\_paused`is_paused()` | æ–¹æ³• | æ£€æŸ¥è¯¥å¯¹è±¡æ˜¯å¦å¤„äºæš‚åœçŠ¶æ€ã€‚ |
#### `Admin` / `Group` / `Friend`
**èŒè´£**: `ListenObject`çš„å…·ä½“å®ç°ã€‚
| ç±» | æ–°å¢å±æ€§/æ–¹æ³• | æè¿° |
| :--- | :--- | :--- |
| \*\***`Admin`** | `level` (å±æ€§) | ç®¡ç†å‘˜çš„æƒé™ç­‰çº§ï¼Œä¾›`Command`æ’ä»¶å†…éƒ¨é€»è¾‘ä½¿ç”¨ã€‚ |
| \**`Group`** | `is_manager(name)` | åˆ¤æ–­æŒ‡å®šç”¨æˆ·æ˜¯å¦ä¸ºæœ¬ç¾¤ç®¡ç†å‘˜ã€‚ |
| | \`get\_manager\_level(name)`get_manager_level(name)` | è·å–æŒ‡å®šç¾¤ç®¡ç†å‘˜çš„æƒé™ç­‰çº§ã€‚ |
| | `add_group_manager(name, level)`| æ·»åŠ æˆ–æ›´æ–°ä¸€ä¸ªç¾¤ç®¡ç†å‘˜ã€‚ |
| | `remove_group_manager(name)` | ç§»é™¤ä¸€ä¸ªç¾¤ç®¡ç†å‘˜ã€‚ |
| **`Friend`** | - | æ— æ–°å¢å±æ€§æˆ–æ–¹æ³•ï¼Œæ˜¯`ListenObject`çš„ç›´æ¥å®ç°ã€‚ |
#### `MessageHistory`
**èŒè´£**: ä¸€ä¸ªåŸºäº`deque`çš„é«˜æ•ˆã€å®šé•¿çš„æ¶ˆæ¯å­˜å‚¨å®¹å™¨ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `max_size` | å±æ€§ (è¯»/å†™) | é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡ã€‚ |
| `add(msg)` | æ–¹æ³• | æ·»åŠ ä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œæœ€è€çš„æ¶ˆæ¯ä¼šè‡ªåŠ¨è¢«æŒ¤å‡ºã€‚ |
| `get_all()` | æ–¹æ³• | ä»¥åˆ—è¡¨å½¢å¼è¿”å›å½“å‰æ‰€æœ‰æ¶ˆæ¯çš„æ‹·è´ã€‚ |
| `clear(num)` | æ–¹æ³• | ä»é˜Ÿåˆ—å¤´éƒ¨ç§»é™¤æŒ‡å®šæ•°é‡çš„æ¶ˆæ¯ã€‚ |
| `__len__()` | æ–¹æ³• | è¿”å›å½“å‰å­˜å‚¨çš„æ¶ˆæ¯æ•°é‡ã€‚ |
### ä¸‰ã€ æ’ä»¶ç³»ç»Ÿ
è¿™æ˜¯æ¡†æ¶æ‰©å±•æ€§çš„æ ¸å¿ƒï¼Œå®šä¹‰äº†ç”¨æˆ·å¦‚ä½•æ³¨å…¥è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚
#### `PluginManager`
**èŒè´£**: æ‰€æœ‰æ’ä»¶çš„â€œæ³¨å†Œä¸ç®¡ç†ä¸­å¿ƒâ€ã€‚
| åç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `register(*plugins)` | æ–¹æ³• | æ³¨å†Œä¸€ä¸ªæˆ–å¤šä¸ªæ’ä»¶å®ä¾‹ã€‚ |
| `register_all(plugins)` | æ–¹æ³• | `register`çš„è¯­æ³•ç³–ï¼Œæ–¹ä¾¿åœ°ä»ä¸€ä¸ªåˆ—è¡¨ä¸­æ³¨å†Œæ‰€æœ‰æ’ä»¶ã€‚ |
| `unregister(name)` | æ–¹æ³• | æ ¹æ®å”¯ä¸€åç§°å®‰å…¨åœ°æ³¨é”€ä¸€ä¸ªæ’ä»¶ã€‚ |
| `get_plugin(name)` | æ–¹æ³• | æ ¹æ®å”¯ä¸€åç§°è·å–æ’ä»¶å®ä¾‹ï¼Œä¾›`LoopController`ä½¿ç”¨ã€‚ |
#### æ’ä»¶åŸºç±» (ABCs)
**èŒè´£**: å®šä¹‰äº†ä¸åŒç±»å‹æ’ä»¶å¿…é¡»éµå®ˆçš„â€œå¥‘çº¦â€ï¼Œä¸»è¦æ˜¯`execute`æ–¹æ³•çš„ç­¾åã€‚
| ç±» | æ ¸å¿ƒæ–¹æ³• `execute(...)` ç­¾å | æè¿° |
| :--- | :--- | :--- |
| \`Opening`OpeningUp` | `execute(obj) -> str` | **ï¼ˆåŒæ­¥ï¼‰** åœ¨æœºå™¨äººå¯åŠ¨æ—¶å¯¹æ¯ä¸ªå¯¹è±¡æ‰§è¡Œï¼Œè¿”å›é—®å€™è¯­ã€‚ |
| `EndingUp` | `execute(obj) -> str` | **ï¼ˆåŒæ­¥ï¼‰** åœ¨æœºå™¨äººå…³é—­æ—¶å¯¹æ¯ä¸ªå¯¹è±¡æ‰§è¡Œï¼Œè¿”å›å‘Šåˆ«è¯­ã€‚ |
| `Command` | `async execute(controller, driver, context)` | **ï¼ˆå¼‚æ­¥ï¼‰** å“åº”ç®¡ç†å‘˜æˆ–ç¾¤ç®¡çš„å‘½ä»¤ã€‚`context`åŒ…å«æ‰€æœ‰æƒé™å’Œæ¶ˆæ¯ä¿¡æ¯ã€‚ |
| `MsgFilter` | `execute(obj, msg) -> bool` | **ï¼ˆåŒæ­¥ï¼‰** æ¶ˆæ¯è¿‡æ»¤å™¨ã€‚è¿”å›`False`åˆ™è¯¥æ¶ˆæ¯è¢«æ‹¦æˆªï¼Œä¸å†ç»§ç»­å¤„ç†ã€‚ |
| `MsgResponser` | \`async execute(driver`async execute(driver, obj, msg)` | **ï¼ˆå¼‚æ­¥ï¼‰** å“åº”æ™®é€šæ¶ˆæ¯çš„æ ¸å¿ƒé€»è¾‘ï¼Œå¦‚å…³é”®è¯å›å¤ã€è°ƒç”¨AIç­‰ã€‚ |
#### `CommandContext` (`NamedTuple`)
**èŒè´£**: åœ¨æ‰§è¡Œ`Command`æ’ä»¶æ—¶ï¼Œä½œä¸ºä¸€ä¸ªåªè¯»çš„æ•°æ®å®¹å™¨ï¼Œå°è£…äº†æ‰€æœ‰å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
| å­—æ®µå | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `is_admin` | `bool` | æ¶ˆæ¯æ¥æºæ˜¯å¦ä¸ºå…¨å±€`Admin`ã€‚ |
| `admin_level` | `Optional[int]` | `Admin`çš„æƒé™ç­‰çº§ã€‚ |
| `is_group_manager` | `bool` | æ¶ˆæ¯å‘é€è€…æ˜¯å¦ä¸ºå½“å‰ç¾¤çš„`GroupManager`ã€‚ |
| `group_manager_level` | `Optional[int]` | `GroupManager`çš„ç¾¤å†…æƒé™ç­‰çº§ã€‚ |
| `source_object` | `ListenObject` | æ¶ˆæ¯æ¥æºçš„å¯¹è±¡å®ä¾‹ï¼ˆ`Admin`æˆ–`Group`ï¼‰ã€‚ |
| `message` | `Message` | è§¦å‘å‘½ä»¤çš„åŸå§‹æ¶ˆæ¯å¯¹è±¡ã€‚ |
-----
